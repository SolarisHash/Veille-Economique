#!/usr/bin/env python3
# -*- coding: utf-8 -*-
"""
Test direct pour comprendre exactement o√π les donn√©es se perdent
"""

import sys
import json
from pathlib import Path
from datetime import datetime, timedelta
sys.path.insert(0, "scripts")

def test_pipeline_complet():
    """Test du pipeline complet √©tape par √©tape"""
    print("üî¨ TEST PIPELINE COMPLET √âTAPE PAR √âTAPE")
    print("=" * 70)
    
    try:
        # 1. IMPORT DES MODULES
        print("\n1Ô∏è‚É£ IMPORT DES MODULES")
        print("-" * 40)
        
        from recherche_web import RechercheWeb
        from analyseur_thematiques import AnalyseurThematiques
        
        print("‚úÖ Modules import√©s avec succ√®s")
        
        # 2. INITIALISATION
        print("\n2Ô∏è‚É£ INITIALISATION")
        print("-" * 40)
        
        recherche = RechercheWeb(timedelta(days=180))
        thematiques = ['recrutements', 'evenements', 'innovations', 'vie_entreprise']
        analyseur = AnalyseurThematiques(thematiques)
        
        print(f"‚úÖ Recherche initialis√©e")
        print(f"‚úÖ Analyseur initialis√© (seuil: {analyseur.seuil_pertinence})")
        
        # 3. ENTREPRISE DE TEST
        print("\n3Ô∏è‚É£ ENTREPRISE DE TEST")
        print("-" * 40)
        
        entreprise_test = {
            'nom': 'MADAME CLAUDINE ZABLITH',
            'commune': 'Bussy-Saint-Georges',
            'siret': '12345678901234',
            'secteur_naf': 'Services aux entreprises',
            'site_web': ''
        }
        
        print(f"üè¢ Entreprise: {entreprise_test['nom']}")
        print(f"üìç Commune: {entreprise_test['commune']}")
        
        # 4. RECHERCHE WEB
        print("\n4Ô∏è‚É£ RECHERCHE WEB")
        print("-" * 40)
        
        print("üîç Ex√©cution recherche...")
        resultats_recherche = recherche.rechercher_entreprise(entreprise_test)
        
        print(f"üìä R√©sultats de recherche:")
        print(f"   üîë Cl√©s: {list(resultats_recherche.keys())}")
        
        donnees_thematiques = resultats_recherche.get('donnees_thematiques', {})
        print(f"   üìã Th√©matiques trouv√©es: {list(donnees_thematiques.keys())}")
        
        # Analyse d√©taill√©e de chaque th√©matique
        total_resultats_valides = 0
        for thematique, donnees in donnees_thematiques.items():
            if isinstance(donnees, dict):
                pertinence = donnees.get('pertinence', 0)
                nb_extraits = len(donnees.get('extraits_textuels', []))
                total_resultats_valides += nb_extraits
                print(f"   üéØ {thematique}: pertinence={pertinence:.2f}, extraits={nb_extraits}")
            else:
                print(f"   ‚ö†Ô∏è {thematique}: format inattendu ({type(donnees)})")
        
        print(f"   üìà Total r√©sultats valides: {total_resultats_valides}")
        
        if total_resultats_valides == 0:
            print("‚ùå PROBL√àME: Aucun r√©sultat valide dans la recherche!")
            return False
        
        # 5. PR√âPARATION POUR L'ANALYSEUR
        print("\n5Ô∏è‚É£ PR√âPARATION DONN√âES ANALYSEUR")
        print("-" * 40)
        
        # Format attendu par l'analyseur
        donnees_pour_analyseur = [
            {
                'entreprise': entreprise_test,
                'donnees_thematiques': donnees_thematiques,
                'timestamp': datetime.now().isoformat()
            }
        ]
        
        print(f"üì¶ Donn√©es format√©es pour analyseur:")
        print(f"   üìã Structure: {list(donnees_pour_analyseur[0].keys())}")
        print(f"   üè¢ Entreprise: {donnees_pour_analyseur[0]['entreprise']['nom']}")
        print(f"   üìä Th√©matiques: {list(donnees_pour_analyseur[0]['donnees_thematiques'].keys())}")
        
        # 6. ANALYSE TH√âMATIQUE
        print("\n6Ô∏è‚É£ ANALYSE TH√âMATIQUE")
        print("-" * 40)
        
        print("üî¨ Ex√©cution analyse...")
        resultats_analyses = analyseur.analyser_resultats(donnees_pour_analyseur)
        
        print(f"üìä R√©sultats d'analyse:")
        print(f"   üìã Nombre d'entreprises: {len(resultats_analyses)}")
        
        if len(resultats_analyses) > 0:
            entreprise_analysee = resultats_analyses[0]
            
            print(f"\n7Ô∏è‚É£ R√âSULTATS D√âTAILL√âS")
            print("-" * 40)
            
            nom = entreprise_analysee.get('nom', 'N/A')
            score_global = entreprise_analysee.get('score_global', 0)
            thematiques_principales = entreprise_analysee.get('thematiques_principales', [])
            
            print(f"üè¢ Entreprise: {nom}")
            print(f"üèÜ Score global: {score_global:.3f}")
            print(f"üéØ Th√©matiques principales: {thematiques_principales}")
            
            # D√©tail par th√©matique
            analyse_thematique = entreprise_analysee.get('analyse_thematique', {})
            print(f"\nüìã D√âTAIL PAR TH√âMATIQUE:")
            
            for thematique, details in analyse_thematique.items():
                trouve = details.get('trouve', False)
                score = details.get('score_pertinence', 0)
                sources = details.get('sources', [])
                nb_details = len(details.get('details', []))
                
                status = "‚úÖ" if trouve else "‚ùå"
                print(f"   {status} {thematique}: score={score:.3f}, sources={sources}, d√©tails={nb_details}")
                
                # Si pas trouv√©, debug pourquoi
                if not trouve and thematique in donnees_thematiques:
                    donnee_originale = donnees_thematiques[thematique]
                    pertinence_orig = donnee_originale.get('pertinence', 0)
                    print(f"      üîç Debug: pertinence originale={pertinence_orig}, seuil={analyseur.seuil_pertinence}")
                    
                    if pertinence_orig > analyseur.seuil_pertinence:
                        print(f"      ‚ö†Ô∏è PROBL√àME: Score suffisant mais pas d√©tect√©!")
            
            # 8. VERDICT
            print(f"\n8Ô∏è‚É£ VERDICT")
            print("-" * 40)
            
            if score_global > 0.0:
                print("üéâ SUCC√àS: L'analyseur fonctionne!")
                print(f"   Score: {score_global:.3f}")
                print(f"   Th√©matiques: {len(thematiques_principales)}")
                return True
            else:
                print("‚ùå √âCHEC: Score global = 0")
                print("   L'analyseur ne d√©tecte rien malgr√© les donn√©es")
                
                # Debug approfondi
                print(f"\nüîç DEBUG APPROFONDI:")
                for thematique in donnees_thematiques.keys():
                    donnee = donnees_thematiques[thematique]
                    pertinence = donnee.get('pertinence', 0)
                    print(f"   {thematique}: pertinence={pertinence} vs seuil={analyseur.seuil_pertinence}")
                    
                    if pertinence > analyseur.seuil_pertinence:
                        print(f"      ‚ö†Ô∏è Devrait √™tre d√©tect√© mais ne l'est pas!")
                
                return False
        else:
            print("‚ùå √âCHEC: Aucun r√©sultat d'analyse retourn√©")
            return False
        
    except Exception as e:
        print(f"‚ùå ERREUR PIPELINE: {e}")
        import traceback
        traceback.print_exc()
        return False

def test_analyseur_minimal():
    """Test minimal de l'analyseur avec donn√©es garanties"""
    print("\nüß™ TEST ANALYSEUR MINIMAL")
    print("=" * 70)
    
    try:
        from analyseur_thematiques import AnalyseurThematiques
        
        # Configuration minimale
        thematiques = ['recrutements']
        analyseur = AnalyseurThematiques(thematiques)
        
        # R√©duction forc√©e du seuil pour ce test
        analyseur.seuil_pertinence = 0.05  # Tr√®s permissif
        
        print(f"üéØ Seuil de test: {analyseur.seuil_pertinence}")
        
        # Donn√©es test avec score √©lev√© garanti
        donnees_test = [
            {
                'entreprise': {
                    'nom': 'TEST ENTREPRISE',
                    'commune': 'Test Ville'
                },
                'donnees_thematiques': {
                    'recrutements': {
                        'mots_cles_trouves': ['recrutement', 'emploi', 'CDI'],
                        'pertinence': 2.5,  # Score √©lev√©
                        'extraits_textuels': [
                            {
                                'titre': 'TEST ENTREPRISE recrute',
                                'description': 'Offre emploi CDI disponible',
                                'url': 'https://test.com'
                            },
                            {
                                'titre': 'Recrutement TEST ENTREPRISE',
                                'description': 'Nous recherchons candidats',
                                'url': 'https://test2.com'
                            }
                        ],
                        'urls': ['https://test.com', 'https://test2.com'],
                        'type': 'recherche_test'
                    }
                }
            }
        ]
        
        print("üìä Test avec donn√©es garanties...")
        resultats = analyseur.analyser_resultats(donnees_test)
        
        if resultats and len(resultats) > 0:
            entreprise = resultats[0]
            score = entreprise.get('score_global', 0)
            
            print(f"üèÜ Score obtenu: {score:.3f}")
            
            if score > 0.0:
                print("üéâ ANALYSEUR FONCTIONNE avec donn√©es forc√©es!")
                return True
            else:
                print("‚ùå ANALYSEUR NE FONCTIONNE PAS m√™me avec donn√©es forc√©es!")
                
                # Debug tr√®s d√©taill√©
                analyse = entreprise.get('analyse_thematique', {})
                if 'recrutements' in analyse:
                    details = analyse['recrutements']
                    print(f"üîç D√©tails recrutements:")
                    print(f"   trouve: {details.get('trouve', False)}")
                    print(f"   score: {details.get('score_pertinence', 0)}")
                    print(f"   sources: {details.get('sources', [])}")
                
                return False
        else:
            print("‚ùå Aucun r√©sultat retourn√©")
            return False
        
    except Exception as e:
        print(f"‚ùå Erreur test minimal: {e}")
        import traceback
        traceback.print_exc()
        return False

def main():
    """Test complet d'int√©gration"""
    print("üöÄ TEST DIRECT D'INT√âGRATION")
    print("=" * 80)
    
    # Test 1: Pipeline complet
    pipeline_ok = test_pipeline_complet()
    
    # Test 2: Analyseur minimal si pipeline √©choue
    if not pipeline_ok:
        print("\n" + "="*80)
        analyseur_ok = test_analyseur_minimal()
        
        if analyseur_ok:
            print("\nüí° DIAGNOSTIC:")
            print("   ‚úÖ L'analyseur fonctionne")
            print("   ‚ùå Le probl√®me vient des donn√©es de recherche")
            print("   üîß Solution: Adapter le format des donn√©es")
        else:
            print("\nüí° DIAGNOSTIC:")
            print("   ‚ùå L'analyseur lui-m√™me ne fonctionne pas")
            print("   üîß Solution: Corriger le code de l'analyseur")
    else:
        print("\nüéâ SYST√àME FONCTIONNEL!")
        print("Le probl√®me doit √™tre ailleurs dans votre script principal")

if __name__ == "__main__":
    main()